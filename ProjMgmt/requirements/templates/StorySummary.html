    {% load staticfiles %}
    {% load require_tags %}

    {% if confirm_message %}
    <div class="modal-dialog modal-lg">
    {% else %}
    <div class="modal-dialog">
    {% endif %}
        <div class="modal-content">
            <div class="modal-header">
                <a class="btn close" aria-label="Close" href="javascript:void(0);" onclick="closeStoryDialog();">
                    <span aria-hidden="true">Ã—</span>
                </a>
                <h4 class="modal-title" id="storyModalLabel">{{ title }}</h4>
            </div>
            <form id="storyForm" class="form-horizontal" action="{{ action }}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    {% if confirm_message %}
                    <!-- This branch gives the option of deleting a story. -->
                        <h2><span class="label label-danger">Warning :</span></h2>
                        <h3>{{ confirm_message }}</h3>
                        <hr>
                        <h4>{{ form.title.label_tag }}</h4>
                        <h5>{{ form.title.value }}</h5>
                        <h4>{{ form.description.label_tag }}</h4>
                        <h5>
                            {{ form.description.value }}
                        </h5>
                        <h4>{{ form.reason.label_tag }}</h4>
                        <h5>{{ form.reason.value }}</h5>
                        <h4>{{ form.hours.label_tag }}</h4>
                        <h5>{{ form.hours.value }}</h5>
                        <h4>{{ form.test.label_tag }}</h4>
                        <h5>
                            {{ form.test.value }}
                        </h5>
                        <h4>{{ form.points.label_tag }}</h4>
                        <h5>{{ form.points.value }}</h5>
                    {% else %}
                    <!-- This branch gives the option of editing a story. -->

                        <h4>{{ form.title.label_tag }}
                        </h4>
                        <p>{{ form.title }}</p>
                        <hr>
                        <h4>{{ form.description.label_tag }}</h4>
                        <p>{{ form.description }}</p>
                        <hr>
                        <h4>{{ form.reason.label_tag }}</h4>
                        <p>{{ form.reason }}</p>
                        <hr>
                        <h4>{{ form.test.label_tag }}</h4>
                        <p>{{ form.test }}</p>
                        <hr>
                        
                        {% check_permission association project "EditHours" as can_edit_hours %}
                        {% if can_edit_hours %}
                            <h4>{{ form.hours.label_tag }}</h4>
                            <p>{{ form.hours }}</p>
                            <hr>
                        {% endif %}
                        
                        
                        <h4>{{ form.status.label_tag}}</h4>
                        <p> {{ form.status }}</p>
                        <hr>
                        {% check_permission association project "EditPoints" as can_edit_points %}
                        {% if can_edit_points %}
                            <h4>{{ form.points.label_tag}}</h4>
                            <p> {{ form.points }}</p>
                            <hr>
                        {% endif %}

                        {% check_permission association project "PauseStory" as can_pause %}
                        {% if can_pause %}
                            <h4> {{ form.pause.label_tag}}</h4>
                            <p>{{ form.pause }}</p>
                        {% endif %}
                    {% endif %}
                </div>
                <div class="modal-footer">
                    
                    <a class = "btn btn-default" id ="btn-state" onclick="change_state();"> Next State</a>
                    <!--<a class="btn btn-default" onclick="change_state();">Status</a>-->
                    <a class="btn btn-default" href="javascript:void(0);" onclick="closeStoryDialog();">Close</a>
                    {% if confirm_message %}
                    <button type="submit" class="btn btn-danger">{{ desc }}</button>
                    {% else %}
                    <button type="submit" class="btn btn-primary">{{ desc }}</button>

                    {% endif %}
                </div>
            </form>

        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->

    <script type="text/javascript">
        // detect submit button event to use ajax method to post the form
        // and retrive the return data back if there is error object in form object.
        $('#storyForm').on('submit',function(e){
            $(this).ajaxForm({
                type : "POST",
                cache : false,
                url : $(this).attr('action'),
                data : $(this).serialize(),
                success : function(data) {
                    $("#storyModal").html(data);
                },
                async:false
            }).submit();
            e.stopPropagation();
        });

        
        function change_state(){
            var state = document.getElementById("{{ form.status.id_for_label }}");
            if (state.selectedIndex<3){
                document.getElementById("btn-state").disabled=false;
                document.getElementById("btn-state").style.visibility="visible";
               state.selectedIndex =state.selectedIndex+1;
            }
            else{
                document.getElementById("btn-state").disabled=true;
                document.getElementById("btn-state").style.visibility="hidden";
            }
        }

       /*
       When edit form is loaded, the following function checks the status of the story, if it is accepted, the 
       next state button is disabled because there are no more states. After that, it checks the paused feature, if the checkbox is checked, you cannot go to the next state, so the next state button is disabled, if it is unchecked, the next state button is enabled. 
       */

       $(document).ready(function() {
            var state = document.getElementById("{{ form.status.id_for_label }}");
            var paused =document.getElementById("{{ form.pause.id_for_label }}"); 
        
            if (state.selectedIndex>2){
                document.getElementById("btn-state").disabled=true;
                document.getElementById("btn-state").style.visibility="hidden";
            }

            if (paused.checked==true){
                document.getElementById("btn-state").disabled=true;
                document.getElementById("btn-state").style.visibility="hidden"   
            }
        });      

    </script>

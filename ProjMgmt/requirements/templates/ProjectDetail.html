{% extends "SideBarBase.html" %}
{% load require_tags %}
{% block content2 %}

<div id="wrapper">
	<div id="page-wrapper">
		<div class="row">
			<div class="col-lg-12">
				<h1 class="page-header">
					{{ project.title }}
				</h1>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-8 col-md-12">
            	<div class="col-md-12">
            		<div class="panel-group" id="proj_icebox">
            	    	<div class="panel panel-primary">
							<div class="panel-heading">
								<h2 class="panel-title">
									<i class="fa fa-list fa-fw"></i>
									<a data-toggle="collapse" data-parent="" href="#iter_body_icebox" aria-expanded="true">
									Icebox
									</a>
									<a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showStoryDialog('/newstory/{{ project.id }}');">
										<i class="glyphicon glyphicon-plus"></i>
									</a>
								</h2>
							</div>
            	    	    <!-- Icebox -->
            	    	    <div id="iter_body_icebox" class="panel-collapse collapse in" aria-expanded="true">
								<div class="panel-body">
								    <div class="panel-group" id="iter_icebox">
            	    	    	        {% for story in stories %}
            	    	    	        {% if story.iteration == None %}
								        <div class="panel panel-default">
								            <div class="panel-heading">
								                <h4 class="panel-title">
								                    <a data-toggle="collapse" data-parent="" href="#story_{{ story.id }}" aria-expanded="true" class="">
								                    	{{ story.title }}
								                    </a>
            	    	    	                    <div class="btn-group pull-right">
            	    	    	                    	<button class="btn btn-default dropdown-toggle pull-right" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
            	    	    	                        	Move
            	    	    	                        	<span class="caret"></span>
            	    	    	                      	</button>
            	    	    	                      	<ul class="dropdown-menu pull-right" role="menu" aria-labelledby="dropdownMenu1">
            	    	    	                       		{% for iter_local in iterations %}
            	    	    	                        	<li role="presentation">
            	    	    	                        		<a role="menuitem" tabindex="-1" href="/movestorytoiter/{{project.id}}/{{story.id}}/{{iter_local.id}}">{{iter_local.title}}</a>
            	    	    	                        	</li>
            	    	    	                        	{% endfor %}
            	    	    	                      	</ul>
            	    	    	                    </div>
                                                    {% check_permission association project "DeleteProject" as can_delete %} 
                                                    {% if can_delete %}
                                                    <!-- BUG: This button only works the second time you push it. Seems to have to do with the jQuery and Ajax below, which I (AL) don't understand. -->
						    	                    <a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showStoryDialog('/deletestory/{{ project.id }}/{{ story.id }}');">
            	    	    	                    	<i class="fa fa-trash-o fa-fw"></i>Delete
            	    	    	                    </a>
            	    	    	                    {% endif %}
            	    	    	                    <a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showStoryDialog('/editstory/{{ project.id }}/{{ story.id }}');">
            	    	    	                    	<i class="fa fa-edit fa-fw"></i>Edit
            	    	    	                    </a> 
								                </h4>
								            </div>
								            <div id="story_{{ story.id }}" class="panel-collapse collapse in" aria-expanded="true">
								                <div class="panel-body">
                                                    {% if story.last_updated != None %}
                                                    Last Updated: {{story.last_updated }}
                                                    </br></br>
                                                    {% endif %}
								                    {{ story.description }}
								                </div>
								            </div>
								        </div>
            	    	    	        {% endif %}					        
								        {% endfor %}
									</div>
								</div>
							</div>
						</div>
					</div>
            	</div>

		    <!-- Iterations -->
		    {% for iteration in iterations %}
		    	<div class="col-md-12">
            	    <!-- iterations panel -->
            	    <div class="panel-group" id="proj_{{ project.id }}">
            	    	<div class="panel panel-primary">
							<div class="panel-heading">
								<h2 class="panel-title">
									<i class="fa fa-list fa-fw"></i>
									<a data-toggle="collapse" data-parent="" href="#iter_body_{{ iteration.id }}" aria-expanded="true">
										{{ iteration.title }} {{iteration.start_date}} - {{iteration.end_date}}
									</a>
								</h2>
							</div>
							<div id="iter_body_{{ iteration.id }}" class="panel-collapse collapse in" aria-expanded="true">
								<div class="panel-body">
								    <div class="panel-group" id="iter_{{ iteration.id }}">
            	    	    	        <!-- todo i dont think this is resolving the iteration.id variable -->
            	    	    	        <!-- probably need to use a method call to get the list -->
            	    	    	        {% for story in stories%}
            	    	    	        {% if story.iteration == iteration %}
								        <div class="panel panel-default">
								            <div class="panel-heading">
								                <h4 class="panel-title">
								                    <a data-toggle="collapse" data-parent="" href="#story_{{ story.id }}" aria-expanded="true" class="">{{ story.title }}</a>
            	    	    	                    <div class="btn-group pull-right">
            	    	    	                    	<button class="btn btn-default dropdown-toggle pull-right" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true">
            	    	    	                    		Move
            	    	    	                        	<span class="caret"></span>
            	    	    	                      	</button>
            	    	    	                      	<ul class="dropdown-menu pull-right" role="menu" aria-labelledby="dropdownMenu1">
            	    	    	                       		{% for iter_local in iterations %}
            	    	    	                        	{% if not iter_local.title = iteration.title %}
            	    	    	                        	<li role="presentation">
            	    	    	                        		<a role="menuitem" tabindex="-1" href="/movestorytoiter/{{project.id}}/{{story.id}}/{{iter_local.id}}">{{iter_local.title}}</a>
            	    	    	                        	</li>
    														{% endif %}
            	    	    	                        	{% endfor %}
            	    	    	                        	<li role="presentation"><a role="menuitem" tabindex="-1" href="/movestorytoicebox/{{project.id}}/{{story.id}}">Icebox</a></li>
            	    	    	                      	</ul>
            	    	    	                    </div>
													<a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showStoryDialog('/deletestory/{{ project.id }}/{{ story.id }}');">
            	    	    	                    	<i class="fa fa-trash-o fa-fw"></i>Delete
            	    	    	                	</a>
            	    	    	                    <a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showStoryDialog('/editstory/{{ project.id }}/{{ story.id }}');">
            	    	    	                    	<i class="fa fa-edit fa-fw"></i>Edit
            	    	    	                	</a> 
								                </h4>
								            </div>
								            <div id="story_{{ story.id }}" class="panel-collapse collapse in" aria-expanded="true">
								                <div class="panel-body">
                                                    {% if story.last_updated != None %}
                                                    Last Updated: {{story.last_updated }}
                                                    </br></br>
                                                    {% endif %}
								                    {{ story.description }}
								                </div>
								            </div>
								        </div>
            	    	    	        {% endif %}
								        {% endfor %}
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
            {% endfor %}
            </div>

            <!-- User List -->
			<div class="col-lg-4 col-md-12">
				<div class="col-md-12">
					<div class="panel panel-primary" style="min-height: 200px">
						<div class="panel-heading">
							<h2 class="panel-title">
								<i class="fa fa-list fa-fw"></i>
								User List
								<a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showUserDialog('/removeuserfromproject/{{ project.id }}/0');"> 
									<i class="glyphicon glyphicon-minus"></i>
								</a>
								<a class="btn btn-link pull-right" href="javascript:void(0);" onclick="showUserDialog('/addusertoproject/{{ project.id }}/0');">
									<i class="glyphicon glyphicon-plus"></i>
								</a>
							</h2>
						</div>
						<div class="panel-body">
							<ul class="list-group">
							<!-- Display usernames. -->
							<!-- IF user has permission to edit project, give option to edit permissions. -->
							{% if can_edit_project %}
								{% for auser in users %}
								<!-- Display usernames. Click on username to edit permissions. -->
                	            <li class="list-group-item">
                	                <i class="glyphicon glyphicon-user fa-fw"></i> 
                	                <a class="btn btn-link" href="javascript:void(0);" onclick="showUserDialog('/userprojectaccess/{{ project.id }}/{{ auser.id }}');">
                	                {{ auser.username }}
                	                </a>
                	                {% if auser.is_authenticated %}
                	                    <span class="label label-success pull-right">
								        Online    
								        </span>
								    {% else %}
								        <span class="label label-default pull-right">
								        Offline    
								        </span>
								    {% endif %}
                	            </li>
                	            {% endfor %}
                	        {% else %}    
								{% for auser in users %}
								<!-- Display usernames without option to click and edit. -->
                	            <li class="list-group-item">
                	                <i class="glyphicon glyphicon-user fa-fw"></i> 
                	                {{ auser.username }}
                	                {% if auser.is_authenticated %}
                	                    <span class="label label-success pull-right">
								        Online    
								        </span>
								    {% else %}
								        <span class="label label-default pull-right">
								        Offline    
								        </span>
								    {% endif %}
                	            </li>
                	            {% endfor %}
                	        {% endif %}
                	        </ul>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-lg-12">
				{% block usersummary %}
				{% endblock usersummary %}
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">
	var winHeight = $(window).outerHeight();
	$("#page-wrapper").css('min-height',winHeight);

	// use ajax method to load Story Dialog
	// storyUrl will be one of the following three:
	// /newstory or /editstory/projID/storyID or /deletestory/projID/storyID
	function showStoryDialog(storyUrl){
	    $.ajax({
	        url: storyUrl,
	        success: function(result) {
	            $("#storyModal").html(result);
	            $("#storyModal").modal({
	            	backdrop: false,
	            	show: true
	            })
	        },
	        async:false
	    }); 
	}

	// close Story Dialog and erase the content
	function closeStoryDialog(){
	    $("#storyModal").modal('hide');
	    $("#storyModal").html('');
	}
	
	// use ajax method to load User Dialog
	// userUrl will be one of the following three:
	// /addusertoproject/userid , /removeuserfromproject/userid or /userprojectaccess/projectid/userid
	function showUserDialog(userUrl){
	    $.ajax({
	        url: userUrl,
	        success: function(result) {
	            $("#userModal").html(result);
	            $("#userModal").modal({
	            	backdrop: false,
	            	show: true
	            })
	        },
	        async:false
	    }); 
	}

	// close User Dialog and erase the content
	function closeUserDialog(){
	    $("#userModal").modal('hide');
	    $("#userModal").html('');
	}
</script>
{% endblock content2 %}